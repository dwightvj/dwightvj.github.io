---
layout: post
title: Blog Post 1 Completed Assignment
---

### §1. Create a Database

```python
import pandas as pd
import sqlite3
import calendar
from plotly import express as px
from plotly.io import write_html
from sklearn.linear_model import LinearRegression
import warnings
warnings.filterwarnings("ignore")

import seaborn as sns 
from matplotlib import pyplot as plt
import numpy as np
```


```python
df = pd.read_csv("temps.csv")
df.shape
```




    (1359937, 14)




```python
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Year</th>
      <th>VALUE1</th>
      <th>VALUE2</th>
      <th>VALUE3</th>
      <th>VALUE4</th>
      <th>VALUE5</th>
      <th>VALUE6</th>
      <th>VALUE7</th>
      <th>VALUE8</th>
      <th>VALUE9</th>
      <th>VALUE10</th>
      <th>VALUE11</th>
      <th>VALUE12</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>ACW00011604</td>
      <td>1961</td>
      <td>-89.0</td>
      <td>236.0</td>
      <td>472.0</td>
      <td>773.0</td>
      <td>1128.0</td>
      <td>1599.0</td>
      <td>1570.0</td>
      <td>1481.0</td>
      <td>1413.0</td>
      <td>1174.0</td>
      <td>510.0</td>
      <td>-39.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>ACW00011604</td>
      <td>1962</td>
      <td>113.0</td>
      <td>85.0</td>
      <td>-154.0</td>
      <td>635.0</td>
      <td>908.0</td>
      <td>1381.0</td>
      <td>1510.0</td>
      <td>1393.0</td>
      <td>1163.0</td>
      <td>994.0</td>
      <td>323.0</td>
      <td>-126.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>ACW00011604</td>
      <td>1963</td>
      <td>-713.0</td>
      <td>-553.0</td>
      <td>-99.0</td>
      <td>541.0</td>
      <td>1224.0</td>
      <td>1627.0</td>
      <td>1620.0</td>
      <td>1596.0</td>
      <td>1332.0</td>
      <td>940.0</td>
      <td>566.0</td>
      <td>-108.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>ACW00011604</td>
      <td>1964</td>
      <td>62.0</td>
      <td>-85.0</td>
      <td>55.0</td>
      <td>738.0</td>
      <td>1219.0</td>
      <td>1442.0</td>
      <td>1506.0</td>
      <td>1557.0</td>
      <td>1221.0</td>
      <td>788.0</td>
      <td>546.0</td>
      <td>112.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>ACW00011604</td>
      <td>1965</td>
      <td>44.0</td>
      <td>-105.0</td>
      <td>38.0</td>
      <td>590.0</td>
      <td>987.0</td>
      <td>1500.0</td>
      <td>1487.0</td>
      <td>1477.0</td>
      <td>1377.0</td>
      <td>974.0</td>
      <td>31.0</td>
      <td>-178.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
# creates and connect to temps.db
conn = sqlite3.connect("temps.db") # create a database in current directory called temps.db
```


```python
def prepare_df(df):
    df = df.set_index(keys=["ID", "Year"])
    df = df.stack()
    df = df.reset_index()
    df = df.rename(columns = {"level_2"  : "Month" , 0 : "Temp"})
    df["Month"] = df["Month"].str[5:].astype(int)
    df["Temp"]  = df["Temp"] / 100
    return(df)
```


```python
df = prepare_df(df)
```


```python
countries_table = df.copy()
```


```python
df_iter = pd.read_csv("temps.csv", chunksize = 100000)
# for loop is our .next() method from earlier
for i in df_iter:
    temps = prepare_df(i)
    # take pandas df and turn into one or more table objects in database
    # if a temperatrues table exists append to the table (rather than ovewriting)
    temps.to_sql("temperatures", conn, if_exists = "append", index = False)
```


```python
url = "https://raw.githubusercontent.com/PhilChodrow/PIC16B/master/datasets/noaa-ghcn/station-metadata.csv"
stations = pd.read_csv(url)
stations.to_sql("stations", conn, if_exists = "replace", index = False)
```


```python
countries_url = "https://raw.githubusercontent.com/mysociety/gaze/master/data/fips-10-4-to-iso-country-codes.csv"
countries = pd.read_csv(countries_url)
```


```python
countries_table["FIPS 10-4"] = countries_table["ID"].str[0:2]
countries_table = pd.merge(countries_table, countries, on = ["FIPS 10-4"])
countries_table.to_sql("countries", conn, if_exists = "replace", index = False)
```


```python
cursor = conn.cursor()
cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
# retrieve result and conver back to python
print(cursor.fetchall())
```

    [('temperatures',), ('stations',), ('countries',)]
    


```python
cursor.execute("SELECT sql FROM sqlite_master WHERE type='table';")

for result in cursor.fetchall():
    print(result[0])
```

    CREATE TABLE "temperatures" (
    "ID" TEXT,
      "Year" INTEGER,
      "Month" INTEGER,
      "Temp" REAL
    )
    CREATE TABLE "stations" (
    "ID" TEXT,
      "LATITUDE" REAL,
      "LONGITUDE" REAL,
      "STNELEV" REAL,
      "NAME" TEXT
    )
    CREATE TABLE "countries" (
    "ID" TEXT,
      "Year" INTEGER,
      "Month" INTEGER,
      "Temp" REAL,
      "FIPS 10-4" TEXT,
      "ISO 3166" TEXT,
      "Name" TEXT
    )
    
### §2. Write a Query Function

```python
def query_climate_database(country, year_begin, year_end, month):
    cmd = \
    """
    SELECT S.NAME, S.LATITUDE, S.LONGITUDE, C.Name, C.Year, C.Month, C.Temp
    FROM stations S
    LEFT JOIN countries C ON S.id = C.id
    WHERE (C.Year >= ? AND C.Year <= ?) AND C.Name = ? AND C.Month = ?
    """
    
    df = pd.read_sql_query(cmd, conn, params=(year_begin, year_end, country, month))
    return df
```


```python
query_climate_database(country = "India", 
                       year_begin = 1980, 
                       year_end = 2020,
                       month = 1)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NAME</th>
      <th>LATITUDE</th>
      <th>LONGITUDE</th>
      <th>Name</th>
      <th>Year</th>
      <th>Month</th>
      <th>Temp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1980</td>
      <td>1</td>
      <td>23.48</td>
    </tr>
    <tr>
      <th>1</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1981</td>
      <td>1</td>
      <td>24.57</td>
    </tr>
    <tr>
      <th>2</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1982</td>
      <td>1</td>
      <td>24.19</td>
    </tr>
    <tr>
      <th>3</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1983</td>
      <td>1</td>
      <td>23.51</td>
    </tr>
    <tr>
      <th>4</th>
      <td>PBO_ANANTAPUR</td>
      <td>14.583</td>
      <td>77.633</td>
      <td>India</td>
      <td>1984</td>
      <td>1</td>
      <td>24.81</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>3147</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1983</td>
      <td>1</td>
      <td>5.10</td>
    </tr>
    <tr>
      <th>3148</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1986</td>
      <td>1</td>
      <td>6.90</td>
    </tr>
    <tr>
      <th>3149</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1994</td>
      <td>1</td>
      <td>8.10</td>
    </tr>
    <tr>
      <th>3150</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1995</td>
      <td>1</td>
      <td>5.60</td>
    </tr>
    <tr>
      <th>3151</th>
      <td>DARJEELING</td>
      <td>27.050</td>
      <td>88.270</td>
      <td>India</td>
      <td>1997</td>
      <td>1</td>
      <td>5.70</td>
    </tr>
  </tbody>
</table>
<p>3152 rows × 7 columns</p>
</div>

### §3. Write a Geographic Scatter Function for Yearly Temperature Increases

```python
def coef(data_group):
    x = data_group[["Year"]] # 2 brackets because X should be a df
    y = data_group["Temp"]   # 1 bracket because y should be a series
    LR = LinearRegression()
    LR.fit(x, y)
    return LR.coef_[0] # simple estimate of rate of change of temp per year 
```


```python
def temperature_coefficient_plot(country, year_begin, year_end, month, min_obs, **kwargs):
    
    df = query_climate_database(country, year_begin, year_end, month)
    
    df = df.groupby('NAME').filter(lambda x: len(x)>=min_obs)
   
    coefs = df.groupby(["NAME", "Month", "LATITUDE", 'LONGITUDE']).apply(coef).reset_index()
    coefs.rename(columns = {0 : 'Estimated Yearly Increase (°C)'}, inplace = True)
    coefs = coefs.round({'Estimated Yearly Increase (°C)': 4})
 
    fig = px.scatter_mapbox(coefs, lat="LATITUDE", lon="LONGITUDE", 
                            color='Estimated Yearly Increase (°C)', hover_name="NAME", 
                            title = 'Estimates of yearly increase in temperature in ' + 
                            calendar.month_name[month] + " for stations in" + "<br>"+ country + 
                            ", years " + str(year_begin) + " - " + str(year_end), **kwargs)
    return fig
```


```python
# assumes you have imported necessary packages
color_map = px.colors.diverging.RdGy_r # choose a colormap

fig = temperature_coefficient_plot("India", 1980, 2020, 1, 
                                   min_obs = 10,
                                   zoom = 2,
                                   mapbox_style="carto-positron",
                                   color_continuous_midpoint = 0,
                                   color_continuous_scale=color_map)

fig.show()
```
{% include fig1.html %}

### §4. Create Two More Interesting Figures

```python
from urllib.request import urlopen
import json

countries_gj_url = "https://raw.githubusercontent.com/PhilChodrow/PIC16B/master/datasets/countries.geojson"

with urlopen(countries_gj_url) as response:
    countries_gj = json.load(response)
```

```python
def count_stations(year, **kwargs):
    cmd = \
    """
    SELECT C.Year, C.Name, COUNT(DISTINCT S.NAME)
    FROM stations S
    LEFT JOIN countries C ON S.id = C.id
    WHERE C.Year = ?
    GROUP BY C.Name
    """
    
    df = pd.read_sql_query(cmd, conn, params = [year])
    
    fig = px.choropleth(df, 
                    geojson=countries_gj,
                    locations = "Name",
                    locationmode = "country names",
                    color = "COUNT(DISTINCT S.NAME)",
                    title = "Number of Stations in " + str(year),
                    labels = {"COUNT(DISTINCT S.NAME)" : "Number of Stations", "Name" : 'Country'}, **kwargs)

    fig.update_layout(margin={"r":0,"t":40,"l":0,"b":0})
    
    return fig
```


```python
fig = count_stations(2020, height = 300, color_continuous_scale="haline_r")
fig.show()
```

{% include fig2.html %}

**For my first visualization, I looked at the number of stations in each country for a particular user-specified year. The motivation for this visualization came from wanting to know which countries might prioritize weather station infrastructure over others. Additionally, this plot gives us an idea of how weather stations are distributed globally for any point in time (as far back as 1950).** 


```python
def station_percent_change(stations, **kwargs):
    
    column_list = list(stations)
    cmd = \
    """
    SELECT S.Name, T.Year, ROUND(AVG(T.temp), 1) "Mean Temperature"
    FROM temperatures T
    LEFT JOIN stations S ON T.id = S.id
    WHERE S.Name IN ({})
    GROUP BY S.Name, T.Year
    """.format(','.join(['?'] * len(column_list)))

    df = pd.read_sql_query(cmd, conn, params = column_list)
    v1 = df.groupby(['NAME','Year']).agg({'Mean Temperature':sum}).reset_index()
    v1.rename(columns = {'NAME' : 'Station'}, inplace = True)
    v1['Change'] = v1.groupby('Station')['Mean Temperature'].apply(lambda x: x.pct_change()).to_numpy()*100
    v1.fillna(0, inplace = True)
    
    fig = px.line(v1, x='Year', y='Change', color='Station', labels = {'Change': '% Change'}, 
                 title = "Investigating Historical Percent Change Across Stations",**kwargs)
    
    return fig
```


```python
fig = station_percent_change(['SURAT', 'RAJKOT', 'DWARKA'], hover_name = 'Station', height=400)
fig.show()
```

{% include fig3.html %}

**For my second visualization, I looked at the percent change in temperature year-on-year for some user-specified weather stations. For display purpose, I entered three weather stations in India that I recognized, and plotted the results as a line plot**

```python
conn.close() ## close database connection
```




